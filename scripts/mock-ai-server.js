/**
 * Sunder Mock AI Server
 * Implements a subset of the Gemini API for local development.
 * Allows contributors to work without a real API key.
 */
const express = require('express');
const app = express();
const PORT = process.env.MOCK_AI_PORT || 3002;

app.use(express.json());

// Helper to simulate network delay
const delay = (ms) => new Promise(res => setTimeout(res, ms));

app.post('/v1beta/models/:model:generateContent', async (req, res) => {
    const { model } = req.params;
    const { contents } = req.body;
    const prompt = contents[0].parts[0].text;

    console.log(`[Mock AI] Request for model: ${model}`);
    console.log(`[Mock AI] Prompt length: ${prompt.length}`);

    await delay(800); // Simulate AI generation time

    let responseText = "This is a mock AI response from Sunder's local dev server.";

    // Simple pattern matching for common features
    if (prompt.toLowerCase().includes('translate')) {
        responseText = "/* Mock Translation */\nconsole.log('Hello, world! (Translated)');";
    } else if (prompt.toLowerCase().includes('analyze') || prompt.toLowerCase().includes('security')) {
        responseText = JSON.stringify({
            security: { score: 95, issues: [] },
            performance: { score: 88, suggestions: ["Consider caching this value"] },
            readability: { score: 92 }
        }, null, 2);
    } else if (prompt.toLowerCase().includes('generate') || prompt.toLowerCase().includes('write')) {
        responseText = "// Generated by Sunder Mock AI\nfunction neuralFeature() {\n  return 'Optimized';\n}";
    }

    res.json({
        candidates: [
            {
                content: {
                    parts: [{ text: responseText }],
                    role: 'model'
                },
                finishReason: 'STOP',
                safetyRatings: []
            }
        ],
        usageMetadata: {
            promptTokenCount: 10,
            candidatesTokenCount: 50,
            totalTokenCount: 60
        }
    });
});

app.get('/health', (req, res) => res.json({ status: 'active', provider: 'sunder-mock' }));

app.listen(PORT, () => {
    console.log(`Sunder Mock AI Server sundering on http://localhost:${PORT}`);
});
